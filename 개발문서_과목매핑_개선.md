# 개발문서: ItemAnalysis 과목 매핑 개선

## 1. 현황 분석

### 현재 ItemAnalysis 스키마
```
시험ID | 문항번호 | 정답 | 배점 | 정답률 | 난이도
```
- 과목 정보가 없음
- 문항번호 → 과목 매핑을 코드 내 추론 체인(~130줄)으로 처리

### 현재 추론 로직 흐름
```
getExamStructure_() → 학생 직렬/트랙 판별 → 과목명 + 문항수 결정
         ↓
resolveItemCountsBySubject_() → 과목명 문자열 매칭으로 문항수 재확인
         ↓
getSubjectByQuestionNo_() → 문항번호를 순차 누적하여 과목 배정
```

### 현재 방식의 전제 조건
- 문항 번호가 과목별 순차 배열 (헌법 1~20 → 형사법 21~60 → 경찰학 61~100)
- 과목 순서 및 문항수가 고정
- 위 조건이 깨지면 오작동

### 관련 코드 위치 (Code.gs)
| 함수 | 줄 | 역할 |
|------|-----|------|
| `getExamStructure_()` | 730 | 직렬/트랙 → 과목+문항수 결정 |
| `resolveItemCountsBySubject_()` | 693 | 과목명 → 문항수 매핑 |
| `getSubjectByQuestionNo_()` | 819 | 문항번호 → 과목명 변환 |
| `inferFireTrack_()` | 676 | 소방 세부 트랙 추론 |
| `getScoreAnalysis()` 내부 | 1519, 1758, 1778 | 실제 사용처 |

---

## 2. 개선안: 과목명 컬럼 추가 (선택적 입력)

### 변경된 스키마
```
기존: 시험ID | 문항번호 | 정답   | 배점 | 정답률 | 난이도
개선: 시험ID | 문항번호 | 과목명 | 정답 | 배점   | 정답률 | 난이도
```

- 과목명 컬럼을 **문항번호 다음(3번째 컬럼)** 에 삽입
- 입력 예시: `헌법`, `형사법`, `경찰학`, `소방학개론`, `행정법` 등

### 동작 원칙
```
과목명 컬럼에 값이 있으면 → 해당 값을 직접 사용
과목명 컬럼이 비어있으면 → 기존 추론 로직(getSubjectByQuestionNo_)으로 fallback
```

---

## 3. 구현 상세

### 3-1. 백엔드 변경 (Code.gs)

#### A. 상수 수정

```javascript
// 변경 전
var QUESTION_HEADERS = ['시험ID', '문항번호', '정답', '배점', '정답률', '난이도'];

var ITEM_COL = {
  EXAM_ID: 0,
  NUM: 1,
  ANSWER: 2,
  POINTS: 3,
  CORRECT_RATE: 4,
  DIFFICULTY: 5
};

// 변경 후
var QUESTION_HEADERS = ['시험ID', '문항번호', '과목명', '정답', '배점', '정답률', '난이도'];

var ITEM_COL = {
  EXAM_ID: 0,
  NUM: 1,
  SUBJECT: 2,      // 신규
  ANSWER: 3,        // 2 → 3
  POINTS: 4,        // 3 → 4
  CORRECT_RATE: 5,  // 4 → 5
  DIFFICULTY: 6     // 5 → 6
};
```

#### B. getScoreAnalysis() 내 과목 매핑 로직 수정

```javascript
// 현재 (추론만 사용)
var mappedSubject = getSubjectByQuestionNo_(qNum, exam.subjects, exam.subjectItemCounts);

// 개선 (시트 값 우선, 없으면 추론 fallback)
var sheetSubject = String(itemRows[q][ITEM_COL.SUBJECT] || '').trim();
var mappedSubject = sheetSubject || getSubjectByQuestionNo_(qNum, exam.subjects, exam.subjectItemCounts);
```

**수정 대상 위치 (3곳):**
- 1519줄: subjectFullScoreMap 계산
- 1758줄: itemAnalysis 배열 구축
- 1778줄: fallback itemAnalysis 구축

#### C. initializeSampleData() 샘플 데이터 수정

```javascript
// 변경 전
qSheet.appendRow(['P2512', 1, '3', 2.5, 75.5, '상', '수사']);

// 변경 후
qSheet.appendRow(['P2512', 1, '헌법', '3', 2.5, 75.5, '상']);
qSheet.appendRow(['P2512', 2, '헌법', '2', 2.5, 62.1, '중']);
// ...
qSheet.appendRow(['P2512', 21, '형사법', '1', 2.5, 48.0, '상']);
```

#### D. 기존 추론 함수 유지 (삭제하지 않음)
- `getExamStructure_()`, `resolveItemCountsBySubject_()`, `getSubjectByQuestionNo_()` 유지
- 과목명 컬럼이 비어있는 기존 데이터에 대한 fallback으로 계속 사용
- 향후 모든 데이터에 과목명이 채워지면 그때 제거 검토

### 3-2. 기존 시트 데이터 호환

| 상황 | 처리 |
|------|------|
| 기존 6컬럼 데이터 (과목명 없음) | `ITEM_COL.SUBJECT` 접근 시 빈값 → 추론 fallback |
| 신규 7컬럼 데이터 (과목명 있음) | 과목명 직접 사용 |
| 혼합 (일부만 과목명 입력) | 행 단위로 개별 판단 |

### 3-3. 시트 마이그레이션

기존 ItemAnalysis_Police, ItemAnalysis_Fire 시트에 과목명 컬럼 삽입 필요:
- 기존 데이터가 있으면: 3번째 위치(C열)에 빈 컬럼 삽입
- 헤더 행 업데이트: `과목명` 추가
- 기존 데이터 행의 과목명은 비워둠 (추론 fallback 사용)

자동 마이그레이션 함수 작성 권장:
```javascript
function migrateItemAnalysisAddSubjectColumn_(sheet) {
  // 1. 현재 헤더 확인 → 이미 7컬럼이면 스킵
  // 2. 3번째 위치에 컬럼 삽입
  // 3. 헤더에 '과목명' 추가
}
```

### 3-4. 프론트엔드 변경 (Index.html)

프론트엔드는 변경 불필요:
- 백엔드가 `itemAnalysis[].subject`에 이미 과목명을 내려주고 있음
- 과목명의 출처(시트 직접값 vs 추론값)가 바뀔 뿐, 프론트 인터페이스는 동일

### 3-5. 관리자 패널 변경 (Admin.html)

향후 성적/문항 일괄 입력 기능 추가 시:
- 문항 입력 폼에 과목명 드롭다운 추가
- 시험 메타데이터(Exams 시트)의 과목 목록을 드롭다운 옵션으로 활용

---

## 4. 구현 순서

```
단계 1: ITEM_COL, QUESTION_HEADERS 상수 수정
단계 2: 시트 마이그레이션 함수 작성 (기존 시트에 빈 컬럼 삽입)
단계 3: getScoreAnalysis() 내 3곳 과목 매핑 로직 수정
단계 4: initializeSampleData() 샘플 데이터 수정
단계 5: 테스트 (기존 6컬럼 데이터 + 신규 7컬럼 데이터 혼합 동작 확인)
```

---

## 5. 기대 효과

| 항목 | 개선 전 | 개선 후 |
|------|---------|---------|
| 과목 판별 | 130줄 추론 코드 의존 | 시트 값 직접 사용 |
| 데이터 가독성 | 시트만 봐서는 과목 파악 불가 | 과목명이 시트에 명시 |
| 시험 구조 변경 | 코드 수정 필요 | 데이터만 변경 |
| 오류 가능성 | 문항 순서/문항수 변경 시 오작동 | 없음 (명시적 매핑) |
| 하위 호환성 | - | 기존 데이터 100% 호환 |

---

## 6. 향후 계획

- 모든 신규 시험 데이터에 과목명 입력 정착 후, 추론 로직 코드 제거 검토
- 관리자 패널에 문항 입력 UI 추가 시 과목명 드롭다운 필수화
